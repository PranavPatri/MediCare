<!DOCTYPE html>
<!-- Coding By CodingNepal - www.codingnepalweb.com -->
<html lang="en" dir="ltr">
  <style>
    /* Import Google font - Poppins */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Poppins", sans-serif;
}
body {
  background-image: url("back.jpg");
  margin:0;
padding:0;
font-family:sans-serif;

overflow:hidden;
}
.chatbot-toggler {
  position: fixed;
  bottom: 20px;
  left: 35px;
  outline: none;
  border: none;
  height: 50px;
  width: 50px;
  display: flex;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background-color: #e84a4c;
  transition: all 0.2s ease;
}
body.show-chatbot .chatbot-toggler {
  transform: rotate(90deg);
}
.chatbot-toggler span {
  color: #fff;
  position: absolute;
}
.chatbot-toggler span:last-child,
body.show-chatbot .chatbot-toggler span:first-child  {
  opacity: 0;
}
body.show-chatbot .chatbot-toggler span:last-child {
  opacity: 1;
}
.chatbot {
  position: fixed;
  left: 35px;
  bottom: 90px;
  width: 420px;
  background: #fff;
  border-radius: 15px;
  overflow: hidden;
  opacity: 0;
  pointer-events: none;
  transform: scale(0.5);
  transform-origin: bottom right;
  box-shadow: 0 0 128px 0 rgba(0,0,0,0.1),
              0 32px 64px -48px rgba(0,0,0,0.5);
  transition: all 0.1s ease;
}
body.show-chatbot .chatbot {
  opacity: 1;
  pointer-events: auto;
  transform: scale(1);
}
.chatbot header {
  padding: 16px 0;
  position: relative;
  text-align: center;
  color: #fff;
  background: rgb(152,147,68);
  background: linear-gradient(90deg, rgba(152,147,68,1) 0%, rgba(19,210,166,1) 17%, rgba(176,2,255,1) 100%);
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.chatbot header span {
  position: absolute;
  right: 15px;
  top: 50%;
  display: none;
  cursor: pointer;
  transform: translateY(-50%);
}
header h2 {
  font-size: 1.4rem;
}
.chatbot .chatbox {
  overflow-y: auto;
  height: 510px;
  padding: 30px 20px 100px;
}
.chatbot :where(.chatbox, textarea)::-webkit-scrollbar {
  width: 6px;
}
.chatbot :where(.chatbox, textarea)::-webkit-scrollbar-track {
  background: #fff;
  border-radius: 25px;
}
.chatbot :where(.chatbox, textarea)::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 25px;
}
.chatbox .chat {
  display: flex;
  list-style: none;
}
.chatbox .outgoing {
  margin: 20px 0;
  justify-content: flex-end;
}
.chatbox .incoming span {
  width: 32px;
  height: 32px;
  color: #fff;
  cursor: default;
  text-align: center;
  line-height: 32px;
  align-self: flex-end;
  background: #724ae8;
  border-radius: 4px;
  margin: 0 10px 7px 0;
}
.chatbox .chat p {
  white-space: pre-wrap;
  padding: 12px 16px;
  border-radius: 10px 10px 0 10px;
  max-width: 75%;
  color: #fff;
  font-size: 0.95rem;
  background: #724ae8;
}
.chatbox .incoming p {
  border-radius: 10px 10px 10px 0;
}
.chatbox .chat p.error {
  color: #721c24;
  background: #f8d7da;
}
.chatbox .incoming p {
  color: #000;
  background: #f2f2f2;
}
.chatbot .chat-input {
  display: flex;
  gap: 5px;
  position: absolute;
  bottom: 0;
  width: 100%;
  background: #fff;
  padding: 3px 20px;
  border-top: 1px solid #ddd;
}
.chat-input textarea {
  height: 55px;
  width: 100%;
  border: none;
  outline: none;
  resize: none;
  max-height: 180px;
  padding: 15px 15px 15px 0;
  font-size: 0.95rem;
}
.chat-input span {
  align-self: flex-end;
  color: #724ae8;
  cursor: pointer;
  height: 55px;
  display: flex;
  align-items: center;
  visibility: hidden;
  font-size: 1.35rem;
}
.chat-input textarea:valid ~ span {
  visibility: visible;
}

@media (max-width: 490px) {
  .chatbot-toggler {
    right: 20px;
    bottom: 20px;
  }
  .chatbot {
    right: 0;
    bottom: 0;
    height: 100%;
    border-radius: 0;
    width: 100%;
  }
  .chatbot .chatbox {
    height: 90%;
    padding: 25px 15px 100px;
  }
  .chatbot .chat-input {
    padding: 5px 15px;
  }
  .chatbot header span {
    display: block;
  }
}

.header{
  position: fixed;
  top: 50px;
  height:50px;
  width: 50px;
  display: flex;
  cursor: pointer;
  border-radius: 50%;
  margin: 40px;  
}
.animate-charcter
{
   text-transform: uppercase;
  background-image: linear-gradient(
    -225deg,
    #231557 0%,
    #44107a 29%,
    #ff1361 67%,
    #fff800 100%
  );
  background-size: auto auto;
  background-clip: border-box;
  background-size: 200% auto;
  color: #fff;
  background-clip: text;
 
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: textclip 2s linear infinite;
      font-size: 140px;
}
.container{
  position: absolute;
  margin-left: 30%;
  margin-top: 15%;
  
  
}
@keyframes textclip {
  to {
    background-position: 200% center;
  }
}
#personalChatBtn{
  position: relative;
  left: 10px;
  width: 45%;
}
#generalQueriesBtn{
  position: relative;
  left: 30px;
  width: 45%;
}

  </style>
  <head>
    <meta charset="utf-8">
    <title>Chatbot in JavaScript | CodingNepal</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts Link For Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
  </head>
  <body>
    <button class="chatbot-toggler">
      <span class="material-symbols-rounded">mode_comment</span>
      <span class="material-symbols-outlined">close</span>
    </button>
    <div class="container">
      <div class="row">
         <div class="col-md-12 text-center">
           <h4 class="animate-charcter"> chatbot </h4>                                                                              
        </div>
      </div>
  </div>
    <div class="chatbot">
      <header>
        <h2>Zippy Chatbot</h2>
        <span class="close-btn material-symbols-outlined">close</span>
      </header>
      <div class="chat-options">
        <!-- <button id="personalChatBtn"  type="button" class="btn btn-outline-danger">Personal Chat</button> -->
        <!-- <button id="generalQueriesBtn" type="button" class="btn btn-outline-success">Queries</button> -->
      </div>
      <ul class="chatbox">
        <li class="chat incoming">
          <span class="material-symbols-outlined">quick_phrases</span>
          <p>Hi there ðŸ‘‹<br>How can I help you today? Your 24/7 MediBot Companion</p>
        </li>
      </ul>
      <div class="chat-input">
        <textarea placeholder="Enter a message..." spellcheck="false" required></textarea>
        <span id="send-btn" class="material-symbols-rounded">send</span>
      </div>
    </div>
  </body>
<script>
  const chatbotToggler = document.querySelector(".chatbot-toggler");
const closeBtn = document.querySelector(".close-btn");
const chatbox = document.querySelector(".chatbox");
const chatInput = document.querySelector(".chat-input textarea");
const sendChatBtn = document.querySelector(".chat-input span");

let userMessage = null;
const API_KEY = YOUR_API_KEY;
const RETRIEVE_DATA_URL = "retrieve_data.php";

const inputInitHeight = chatInput.scrollHeight;

const createChatLi = (message, className) => {
    const chatLi = document.createElement("li");
    chatLi.classList.add("chat", `${className}`);
    let chatContent = className === "outgoing" ? `<p></p>` : `<span class="material-symbols-outlined">quick_phrases</span><p></p>`;
    chatLi.innerHTML = chatContent;
    chatLi.querySelector("p").innerHTML = message;
    chatLi.style.marginBottom = "10px";
    return chatLi;
}

const generateResponse = (chatElement) => {
    const messageElement = chatElement.querySelector("p");

    const API_URL = "/api/getresponse/";
    const requestOptions = {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ "messages": userMessage })
    };

    fetch(API_URL, requestOptions)
    .then(res => res.json())
    .then(data => {
      console.log()
        messageElement.textContent = JSON.stringify(data.replay);
    })
    .catch(() => {
        messageElement.classList.add("error");
        messageElement.textContent = "Oops! Something went wrong. Please try again.";
    })
    .finally(() => chatbox.scrollTo(0, chatbox.scrollHeight));
};

const handlePersonalChat = () => {
    chatbox.innerHTML = "";
    chatbox.appendChild(createChatLi("Hi there! To provide personalized information, please enter your UniqueID:", "incoming"));
    chatbox.appendChild(createChatLi("<input type='text' id='uniqueIDInput' style='padding: 5px; width:120px;'>&nbsp;&nbsp;&nbsp;<button onclick='submitUniqueID()' style='background-color: purple;border-radius:30px; color: white; padding: 8px 12px; border: none; border-radius:10px; cursor: pointer;'>Submit</button>", "incoming"));

    window.submitUniqueID = () => {
        const uniqueID = document.getElementById("uniqueIDInput").value;

        if (uniqueID.trim() !== "") {
            chatbox.appendChild(createChatLi("Fetching data...", "incoming"));

            fetch(RETRIEVE_DATA_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: `uniqueID=${uniqueID}`,
            })
            .then((res) => res.json())
            .then((data) => {
                console.log(data); // Debug statement

                if (data.error) {
                    chatbox.appendChild(createChatLi(data.error, "incoming"));
                } else {
                    chatbox.appendChild(createChatLi(`Employee ID: ${data.empid}<br>Name: ${data.name}<br>Department: ${data.dpt}<br>Location: ${data.location}`, "incoming"));

                    console.log(data.agreement); // Debug statement

                    if (data.agreement) {
                        console.log('Creating download button'); // Debug statement

                        const downloadButton = document.createElement('button');
                        downloadButton.textContent = 'Download Agreement PDF';
                        downloadButton.style.backgroundColor = 'purple';
                        downloadButton.style.color = 'white';
                        downloadButton.style.padding = '8px 12px';
                        downloadButton.style.border = 'none';
                        downloadButton.style.borderRadius = '10px';
                        downloadButton.style.cursor = 'pointer';

                        downloadButton.addEventListener('click', () => {
                            const pdfBlob = base64toBlob(data.agreement, 'application/pdf');
                            const downloadLink = document.createElement('a');
                            downloadLink.href = URL.createObjectURL(pdfBlob);
                            downloadLink.download = 'employee_agreement.pdf';
                            downloadLink.click();
                        });

                        chatbox.appendChild(downloadButton);
                    }
                }
            })
            .catch(() => {
                chatbox.lastChild.classList.add("error");
                chatbox.lastChild.textContent = "Oops! Something went wrong. Please try again.";
            })
            .finally(() => chatbox.scrollTo(0, chatbox.scrollHeight));
        } else {
            chatbox.appendChild(createChatLi("Please enter a valid UniqueID.", "incoming"));
        }
    };

    document.getElementById("uniqueIDInput").focus();
};

const handleGeneralQueries = () => {
    chatbox.innerHTML = "";
    chatbox.appendChild(createChatLi("Hi there! How can I assist you today?", "incoming"));
};

const handleChat = () => {
    userMessage = chatInput.value.trim();
    if (!userMessage) return;

    chatInput.value = "";
    chatInput.style.height = `${inputInitHeight}px`;

    chatbox.appendChild(createChatLi(userMessage, "outgoing"));
    chatbox.scrollTo(0, chatbox.scrollHeight);

    setTimeout(() => {
        const incomingChatLi = createChatLi("MediBot is typing...", "incoming");
        chatbox.appendChild(incomingChatLi);
        chatbox.scrollTo(0, chatbox.scrollHeight);

        if (userMessage.toLowerCase().includes("personal chat") || userMessage.toLowerCase().includes("employee details")) {
            handlePersonalChat();
        } else if (userMessage.toLowerCase().includes("general queries")) {
            handleGeneralQueries();
        } else {
            generateResponse(incomingChatLi);
        }
    }, 600);
};

chatInput.addEventListener("input", () => {
    chatInput.style.height = `${inputInitHeight}px`;
    chatInput.style.height = `${chatInput.scrollHeight}px`;
});

chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey && window.innerWidth > 800) {
        e.preventDefault();
        handleChat();
    }
});

sendChatBtn.addEventListener("click", handleChat);
closeBtn.addEventListener("click", () => document.body.classList.remove("show-chatbot"));
chatbotToggler.addEventListener("click", () => document.body.classList.toggle("show-chatbot"));

document.getElementById("personalChatBtn").addEventListener("click", handlePersonalChat);
document.getElementById("generalQueriesBtn").addEventListener("click", handleGeneralQueries);

function base64toBlob(base64Data, contentType) {
    contentType = contentType || '';
    const sliceSize = 1024;
    const byteCharacters = atob(base64Data);
    const byteArrays = [];

    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
        const byteNumbers = new Array(slice.length);

        for (let i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
        }

        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
    }

    return new Blob(byteArrays, { type: contentType });
}

</script>
</html>
